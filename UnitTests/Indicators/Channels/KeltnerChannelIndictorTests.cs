// ********************************************************
// Copyright (C) 2021 Louis S. Berman (louis@squideyes.com)
//
// This file is part of SquidEyes.Trading
//
// The use of this source code is licensed under the terms
// of the MIT License (https://opensource.org/licenses/MIT)
// ********************************************************

using FluentAssertions;
using SquidEyes.Trading.Context;
using SquidEyes.Trading.Indicators;
using SquidEyes.UnitTests.Testing;
using Xunit;

namespace SquidEyes.UnitTests.Indicators;

public class KeltnerChannelIndictorTests
{
    [Fact]
    public void KeltnerChannelIndicatorBaseline()
    {
        var results = new (double Upper, double Middle, double Lower)[]
        {
            (111696.16666667, 111667.66666667, 111639.16666667),
            (111686.08333333, 111661.33333333, 111636.58333333),
            (111690.50000000, 111651.00000000, 111611.50000000),
            (111687.54166667, 111641.41666667, 111595.29166667),
            (111682.33333333, 111636.13333333, 111589.93333333),
            (111671.30555556, 111631.55555556, 111591.80555556),
            (111663.07142857, 111628.14285714, 111593.21428571),
            (111659.41666667, 111626.41666667, 111593.41666667),
            (111655.53703704, 111625.03703704, 111594.53703704),
            (111651.93333333, 111623.73333333, 111595.53333333),
            (111648.75757576, 111622.57575758, 111596.39393939),
            (111647.58333333, 111620.83333333, 111594.08333333),
            (111647.12820513, 111619.66666667, 111592.20512821),
            (111649.82142857, 111620.35714286, 111590.89285714),
            (111650.04444444, 111621.44444444, 111592.84444444),
            (111654.44791667, 111623.79166667, 111593.13541667),
            (111657.43137255, 111625.66666667, 111593.90196078),
            (111659.80555556, 111628.05555556, 111596.30555556),
            (111661.45614035, 111630.19298246, 111598.92982456),
            (111662.98333333, 111631.33333333, 111599.68333333),
            (111662.71666667, 111630.76666667, 111598.81666667),
            (111662.54166667, 111630.51666667, 111598.49166667),
            (111661.77500000, 111630.20000000, 111598.62500000),
            (111659.75833333, 111630.13333333, 111600.50833333),
            (111660.72500000, 111630.65000000, 111600.57500000),
            (111665.32500000, 111633.15000000, 111600.97500000),
            (111669.05000000, 111635.15000000, 111601.25000000),
            (111671.12500000, 111637.00000000, 111602.87500000),
            (111674.35833333, 111639.33333333, 111604.30833333),
            (111678.25000000, 111642.40000000, 111606.55000000),
            (111681.95833333, 111645.43333333, 111608.90833333),
            (111685.83333333, 111648.63333333, 111611.43333333),
            (111689.15833333, 111651.88333333, 111614.60833333),
            (111689.24166667, 111654.06666667, 111618.89166667),
            (111691.38333333, 111655.23333333, 111619.08333333),
            (111688.97500000, 111654.25000000, 111619.52500000),
            (111686.91666667, 111653.61666667, 111620.31666667),
            (111685.36666667, 111652.36666667, 111619.36666667),
            (111684.35000000, 111650.45000000, 111616.55000000),
            (111682.55833333, 111649.33333333, 111616.10833333),
            (111680.57500000, 111648.25000000, 111615.92500000),
            (111679.49166667, 111647.46666667, 111615.44166667),
            (111678.00000000, 111647.70000000, 111617.40000000),
            (111678.11666667, 111648.11666667, 111618.11666667),
            (111676.06666667, 111648.01666667, 111619.96666667),
            (111672.80000000, 111646.25000000, 111619.70000000),
            (111671.25000000, 111645.15000000, 111619.05000000),
            (111669.96666667, 111644.01666667, 111618.06666667),
            (111668.57500000, 111642.85000000, 111617.12500000),
            (111666.86666667, 111641.06666667, 111615.26666667),
            (111664.86666667, 111639.21666667, 111613.56666667),
            (111661.41666667, 111637.56666667, 111613.71666667),
            (111659.06666667, 111635.81666667, 111612.56666667),
            (111659.63333333, 111635.03333333, 111610.43333333),
            (111658.80833333, 111635.18333333, 111611.55833333),
            (111659.55833333, 111636.23333333, 111612.90833333),
            (111659.96666667, 111637.01666667, 111614.06666667),
            (111660.15833333, 111638.03333333, 111615.90833333),
            (111660.70833333, 111639.33333333, 111617.95833333),
            (111661.23333333, 111640.38333333, 111619.53333333),
            (111663.74166667, 111642.06666667, 111620.39166667),
            (111665.60833333, 111644.08333333, 111622.55833333),
            (111667.29166667, 111646.51666667, 111625.74166667),
            (111671.24166667, 111649.86666667, 111628.49166667),
            (111675.03333333, 111653.58333333, 111632.13333333),
            (111678.71666667, 111657.56666667, 111636.41666667),
            (111682.04166667, 111661.56666667, 111641.09166667),
            (111686.04166667, 111664.51666667, 111642.99166667),
            (111687.90000000, 111666.45000000, 111645.00000000),
            (111690.21666667, 111668.61666667, 111647.01666667),
            (111692.95833333, 111670.83333333, 111648.70833333),
            (111695.99166667, 111672.51666667, 111649.04166667),
            (111696.48333333, 111673.38333333, 111650.28333333),
            (111695.36666667, 111673.31666667, 111651.26666667),
            (111695.00000000, 111672.95000000, 111650.90000000),
            (111694.17500000, 111672.65000000, 111651.12500000),
            (111694.25000000, 111672.05000000, 111649.85000000),
            (111693.65000000, 111670.55000000, 111647.45000000),
            (111691.66666667, 111669.31666667, 111646.96666667),
            (111690.70833333, 111668.28333333, 111645.85833333),
            (111687.51666667, 111666.21666667, 111644.91666667),
            (111685.27500000, 111663.60000000, 111641.92500000),
            (111683.49166667, 111661.06666667, 111638.64166667),
            (111680.71666667, 111658.66666667, 111636.61666667),
            (111677.94166667, 111656.11666667, 111634.29166667),
            (111674.85833333, 111653.03333333, 111631.20833333),
            (111671.34166667, 111649.81666667, 111628.29166667),
            (111667.50833333, 111647.63333333, 111627.75833333),
            (111665.18333333, 111646.13333333, 111627.08333333),
            (111662.47500000, 111644.40000000, 111626.32500000),
            (111660.45000000, 111642.30000000, 111624.15000000),
            (111657.12500000, 111640.70000000, 111624.27500000),
            (111655.94166667, 111639.66666667, 111623.39166667),
            (111654.29166667, 111637.86666667, 111621.44166667),
            (111652.77500000, 111635.90000000, 111619.02500000),
            (111650.84166667, 111634.26666667, 111617.69166667),
            (111648.63333333, 111633.03333333, 111617.43333333),
            (111647.52500000, 111631.85000000, 111616.17500000),
            (111646.60000000, 111629.80000000, 111613.00000000),
            (111644.14166667, 111627.11666667, 111610.09166667),
            (111642.43333333, 111624.88333333, 111607.33333333),
            (111641.80000000, 111623.65000000, 111605.50000000),
            (111639.78333333, 111622.53333333, 111605.28333333),
            (111637.87500000, 111620.10000000, 111602.32500000),
            (111635.22500000, 111617.00000000, 111598.77500000),
            (111634.20833333, 111615.08333333, 111595.95833333),
            (111632.96666667, 111613.46666667, 111593.96666667),
            (111631.28333333, 111611.63333333, 111591.98333333),
            (111631.72500000, 111610.50000000, 111589.27500000),
            (111631.91666667, 111609.41666667, 111586.91666667),
            (111631.12500000, 111608.55000000, 111585.97500000),
            (111632.70000000, 111607.50000000, 111582.30000000),
            (111635.54166667, 111607.56666667, 111579.59166667),
            (111637.55000000, 111608.15000000, 111578.75000000),
            (111639.02500000, 111608.95000000, 111578.87500000),
            (111640.88333333, 111609.68333333, 111578.48333333),
            (111643.20833333, 111611.03333333, 111578.85833333),
            (111644.98333333, 111613.18333333, 111581.38333333),
            (111647.50833333, 111616.53333333, 111585.55833333),
            (111651.89166667, 111620.31666667, 111588.74166667),
            (111656.42500000, 111623.95000000, 111591.47500000),
            (111659.33333333, 111627.08333333, 111594.83333333),
            (111663.32500000, 111629.20000000, 111595.07500000),
            (111667.70833333, 111632.53333333, 111597.35833333),
            (111674.64166667, 111637.51666667, 111600.39166667),
            (111679.27500000, 111641.25000000, 111603.22500000),
            (111682.66666667, 111644.11666667, 111605.56666667),
            (111686.77500000, 111647.55000000, 111608.32500000),
            (111690.24166667, 111650.71666667, 111611.19166667),
            (111695.97500000, 111654.80000000, 111613.62500000),
            (111702.35000000, 111660.20000000, 111618.05000000),
            (111712.27500000, 111668.25000000, 111624.22500000),
            (111719.30833333, 111676.63333333, 111633.95833333),
            (111727.54166667, 111684.41666667, 111641.29166667),
            (111734.51666667, 111691.76666667, 111649.01666667),
            (111742.11666667, 111699.21666667, 111656.31666667),
            (111749.30000000, 111705.20000000, 111661.10000000),
            (111756.97500000, 111711.60000000, 111666.22500000),
            (111765.84166667, 111718.81666667, 111671.79166667),
            (111778.56666667, 111728.16666667, 111677.76666667),
            (111790.40000000, 111739.40000000, 111688.40000000),
            (111803.05833333, 111751.08333333, 111699.10833333),
            (111814.19166667, 111762.96666667, 111711.74166667),
            (111828.67500000, 111775.95000000, 111723.22500000),
            (111839.50000000, 111788.20000000, 111736.90000000),
            (111850.28333333, 111799.73333333, 111749.18333333),
            (111866.07500000, 111813.05000000, 111760.02500000),
            (111881.76666667, 111826.86666667, 111771.96666667),
            (111898.46666667, 111841.31666667, 111784.16666667),
            (111911.15833333, 111854.53333333, 111797.90833333),
            (111922.58333333, 111865.13333333, 111807.68333333),
            (111930.88333333, 111874.33333333, 111817.78333333),
            (111939.05833333, 111882.43333333, 111825.80833333),
            (111945.93333333, 111891.18333333, 111836.43333333),
            (111955.08333333, 111900.63333333, 111846.18333333),
            (111963.90833333, 111909.68333333, 111855.45833333),
            (111974.04166667, 111920.26666667, 111866.49166667),
            (111987.84166667, 111932.11666667, 111876.39166667),
            (111999.46666667, 111943.66666667, 111887.86666667),
            (112007.70000000, 111952.35000000, 111897.00000000),
            (112012.71666667, 111958.41666667, 111904.11666667),
            (112018.84166667, 111964.61666667, 111910.39166667),
            (112027.65000000, 111972.60000000, 111917.55000000),
            (112031.70000000, 111978.30000000, 111924.90000000),
            (112036.44166667, 111982.96666667, 111929.49166667),
            (112041.98333333, 111988.73333333, 111935.48333333),
            (112045.63333333, 111994.18333333, 111942.73333333),
            (112048.21666667, 111998.41666667, 111948.61666667),
            (112048.97500000, 112000.45000000, 111951.92500000),
            (112049.46666667, 112001.46666667, 111953.46666667),
            (112049.80000000, 112003.45000000, 111957.10000000),
            (112048.10000000, 112004.00000000, 111959.90000000),
            (112047.79166667, 112004.51666667, 111961.24166667),
            (112048.30000000, 112005.25000000, 111962.20000000),
            (112048.50833333, 112005.68333333, 111962.85833333),
            (112048.72500000, 112005.75000000, 111962.77500000),
            (112048.55000000, 112005.35000000, 111962.15000000),
            (112043.47500000, 112003.35000000, 111963.22500000),
            (112040.62500000, 112000.65000000, 111960.67500000),
            (112036.54166667, 111999.11666667, 111961.69166667),
            (112036.61666667, 111998.66666667, 111960.71666667),
            (112034.42500000, 111996.85000000, 111959.27500000),
            (112030.51666667, 111992.11666667, 111953.71666667),
            (112025.25833333, 111987.23333333, 111949.20833333),
            (112021.74166667, 111983.56666667, 111945.39166667),
            (112018.90000000, 111980.35000000, 111941.80000000),
            (112015.05833333, 111976.58333333, 111938.10833333),
            (112016.91666667, 111974.46666667, 111932.01666667),
            (112014.30000000, 111973.65000000, 111933.00000000),
            (112014.20833333, 111973.18333333, 111932.15833333),
            (112014.23333333, 111973.43333333, 111932.63333333),
            (112014.70000000, 111974.05000000, 111933.40000000),
            (112016.28333333, 111974.73333333, 111933.18333333),
            (112017.20833333, 111974.38333333, 111931.55833333),
            (112015.97500000, 111973.30000000, 111930.62500000),
            (112015.91666667, 111972.86666667, 111929.81666667),
            (112014.15000000, 111971.55000000, 111928.95000000),
            (112012.55833333, 111969.73333333, 111926.90833333),
            (112010.84166667, 111968.01666667, 111925.19166667),
            (112008.55000000, 111964.60000000, 111920.65000000),
            (112002.93333333, 111959.73333333, 111916.53333333),
            (111998.19166667, 111954.61666667, 111911.04166667),
            (111993.29166667, 111950.01666667, 111906.74166667),
            (111990.22500000, 111945.60000000, 111900.97500000),
            (111985.50000000, 111940.50000000, 111895.50000000),
            (111981.25833333, 111935.73333333, 111890.20833333),
            (111975.70833333, 111930.18333333, 111884.65833333),
            (111964.75000000, 111923.20000000, 111881.65000000),
            (111957.45833333, 111915.08333333, 111872.70833333),
            (111952.79166667, 111909.06666667, 111865.34166667),
            (111948.55000000, 111904.15000000, 111859.75000000),
            (111943.56666667, 111898.11666667, 111852.66666667),
            (111936.59166667, 111890.76666667, 111844.94166667),
            (111930.59166667, 111884.31666667, 111838.04166667),
            (111928.32500000, 111879.80000000, 111831.27500000),
            (111925.60000000, 111875.95000000, 111826.30000000),
            (111923.16666667, 111872.01666667, 111820.86666667),
            (111918.66666667, 111867.21666667, 111815.76666667),
            (111912.42500000, 111861.05000000, 111809.67500000),
            (111909.56666667, 111857.51666667, 111805.46666667),
            (111908.50833333, 111855.63333333, 111802.75833333),
            (111906.63333333, 111854.13333333, 111801.63333333),
            (111906.05000000, 111854.60000000, 111803.15000000),
            (111904.91666667, 111855.71666667, 111806.51666667),
            (111904.47500000, 111856.55000000, 111808.62500000),
            (111903.41666667, 111856.61666667, 111809.81666667),
            (111903.17500000, 111856.90000000, 111810.62500000),
            (111903.60000000, 111857.55000000, 111811.50000000),
            (111905.35833333, 111858.93333333, 111812.50833333),
            (111905.49166667, 111860.71666667, 111815.94166667),
            (111907.45833333, 111862.53333333, 111817.60833333),
            (111912.24166667, 111866.71666667, 111821.19166667),
            (111916.22500000, 111872.05000000, 111827.87500000),
            (111919.93333333, 111876.73333333, 111833.53333333),
            (111920.85000000, 111879.60000000, 111838.35000000),
            (111921.01666667, 111881.86666667, 111842.71666667),
            (111921.63333333, 111884.58333333, 111847.53333333),
            (111924.87500000, 111888.20000000, 111851.52500000),
            (111929.17500000, 111893.10000000, 111857.02500000),
            (111932.56666667, 111897.91666667, 111863.26666667),
            (111936.94166667, 111902.36666667, 111867.79166667),
            (111940.33333333, 111906.88333333, 111873.43333333),
            (111943.00833333, 111910.68333333, 111878.35833333),
            (111946.51666667, 111914.41666667, 111882.31666667),
            (111951.83333333, 111918.98333333, 111886.13333333),
            (111956.11666667, 111923.71666667, 111891.31666667),
            (111960.15000000, 111928.50000000, 111896.85000000),
            (111964.34166667, 111933.06666667, 111901.79166667),
            (111967.81666667, 111938.26666667, 111908.71666667),
            (111970.33333333, 111941.83333333, 111913.33333333),
            (111971.53333333, 111943.03333333, 111914.53333333),
            (111969.32500000, 111942.10000000, 111914.87500000),
            (111967.08333333, 111940.68333333, 111914.28333333),
            (111965.81666667, 111940.16666667, 111914.51666667),
            (111965.85000000, 111939.90000000, 111913.95000000),
            (111965.27500000, 111938.95000000, 111912.62500000),
            (111964.00000000, 111938.20000000, 111912.40000000),
            (111964.33333333, 111938.08333333, 111911.83333333),
            (111964.36666667, 111937.06666667, 111909.76666667),
            (111959.87500000, 111934.30000000, 111908.72500000),
            (111955.20833333, 111931.13333333, 111907.05833333),
            (111953.17500000, 111928.65000000, 111904.12500000),
            (111951.24166667, 111925.96666667, 111900.69166667),
            (111951.02500000, 111924.25000000, 111897.47500000),
            (111948.35000000, 111921.95000000, 111895.55000000),
            (111945.94166667, 111919.16666667, 111892.39166667),
            (111942.97500000, 111916.20000000, 111889.42500000),
            (111940.48333333, 111913.63333333, 111886.78333333),
            (111937.37500000, 111910.45000000, 111883.52500000),
            (111933.73333333, 111907.33333333, 111880.93333333),
            (111930.30000000, 111905.25000000, 111880.20000000),
            (111928.45000000, 111904.00000000, 111879.55000000),
            (111927.85000000, 111903.25000000, 111878.65000000),
            (111926.82500000, 111902.15000000, 111877.47500000),
            (111927.76666667, 111902.41666667, 111877.06666667),
            (111929.10833333, 111903.53333333, 111877.95833333),
            (111930.16666667, 111904.81666667, 111879.46666667),
            (111930.13333333, 111905.83333333, 111881.53333333),
            (111929.85833333, 111907.88333333, 111885.90833333),
            (111932.31666667, 111910.41666667, 111888.51666667),
            (111934.75833333, 111913.08333333, 111891.40833333),
            (111937.80000000, 111915.90000000, 111894.00000000),
            (111939.90833333, 111918.98333333, 111898.05833333),
            (111939.83333333, 111921.23333333, 111902.63333333),
            (111941.79166667, 111923.71666667, 111905.64166667),
            (111946.50000000, 111927.45000000, 111908.40000000),
            (111950.49166667, 111931.51666667, 111912.54166667),
            (111953.58333333, 111934.83333333, 111916.08333333)
        };

        var indicator = new KeltnerChannelIndictor(
            20, Known.Pairs[Symbol.EURUSD], RateToUse.Close, 1.5);

        var candles = IndicatorData.GetCandles();

        candles.Count.Should().Be(results.Length);

        for (var i = 0; i < candles.Count; i++)
        {
            var result = indicator.AddAndCalc(candles[i]);

            result.Upper.Should().BeApproximately(results[i].Upper, 8);
            result.Middle.Should().BeApproximately(results[i].Middle, 8);
            result.Lower.Should().BeApproximately(results[i].Lower, 8);
        }
    }
}