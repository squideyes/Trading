// ********************************************************
// Copyright (C) 2021 Louis S. Berman (louis@squideyes.com)
//
// This file is part of SquidEyes.Trading
//
// The use of this source code is licensed under the terms
// of the MIT License (https://opensource.org/licenses/MIT)
// ********************************************************

using FluentAssertions;
using SquidEyes.Trading.Context;
using SquidEyes.Trading.Indicators;
using SquidEyes.UnitTests.Testing;
using Xunit;

namespace SquidEyes.UnitTests.Indicators;

public class MacdIndicatorTests
{
    [Fact]
    public void IsPrimedReturnsExpectedValue()
    {
        var indicator = new MacdIndicator(
            10, 15, 3, Known.Pairs[Symbol.EURUSD], RateToUse.Close);

        TestingHelper<MacdIndicator>.IsPrimedReturnsExpectedValue(
            indicator, 10, (i, c) => i.AddAndCalc(c), i => i.IsPrimed);
    }

    [Fact]
    public void MacdIndicatorBaseline()
    {
        var results = new (double Value, double Average, double Difference)[]
        {
            (0.00000000, 0.00000000, 0.00000000),
            (-0.00000738, -0.00000810, -0.00000389),
            (-0.00002817, -0.00002820, -0.00000657),
            (-0.00005819, -0.00005770, -0.00000868),
            (-0.00007773, -0.00007497, -0.00000063),
            (-0.00007273, -0.00007137, 0.00000366),
            (-0.00006049, -0.00006033, 0.00000393),
            (-0.00004210, -0.00004148, 0.00000727),
            (-0.00002433, -0.00002559, 0.00000296),
            (-0.00001876, -0.00001919, 0.00000134),
            (-0.00001529, -0.00001532, 0.00000122),
            (-0.00001969, -0.00002051, -0.00000311),
            (-0.00002346, -0.00002206, 0.00000200),
            (0.00000349, 0.00000527, 0.00001205),
            (0.00003627, 0.00003359, 0.00000441),
            (0.00005709, 0.00005692, 0.00000724),
            (0.00006887, 0.00006601, -0.00000220),
            (0.00006821, 0.00006869, 0.00000167),
            (0.00006518, 0.00006328, -0.00000520),
            (0.00004177, 0.00004139, -0.00000783),
            (0.00002290, 0.00002429, -0.00000312),
            (0.00000748, 0.00000703, -0.00000642),
            (-0.00002611, -0.00002640, -0.00001136),
            (-0.00006018, -0.00005785, -0.00000603),
            (-0.00005298, -0.00004904, 0.00000991),
            (-0.00000517, -0.00000499, 0.00001464),
            (0.00001823, 0.00001370, -0.00000197),
            (0.00001596, 0.00001695, 0.00000278),
            (0.00003002, 0.00002979, 0.00000374),
            (0.00004111, 0.00004012, 0.00000156),
            (0.00004248, 0.00004153, -0.00000128),
            (0.00002756, 0.00002633, -0.00000715),
            (0.00001774, 0.00001994, 0.00000182),
            (0.00002174, 0.00002084, -0.00000133),
            (0.00000743, 0.00000651, -0.00000629),
            (-0.00002019, -0.00001991, -0.00000808),
            (-0.00003459, -0.00003202, 0.00000067),
            (-0.00003249, -0.00003248, -0.00000010),
            (-0.00003737, -0.00003742, -0.00000167),
            (-0.00003990, -0.00003894, 0.00000126),
            (-0.00003077, -0.00003012, 0.00000404),
            (-0.00001926, -0.00001975, 0.00000252),
            (-0.00001910, -0.00001999, -0.00000164),
            (-0.00002604, -0.00002564, -0.00000109),
            (-0.00002405, -0.00002309, 0.00000255),
            (-0.00001673, -0.00001703, 0.00000144),
            (-0.00001463, -0.00001487, 0.00000028),
            (-0.00000920, -0.00000861, 0.00000308),
            (0.00000536, 0.00000537, 0.00000456),
            (0.00001906, 0.00001820, 0.00000262),
            (0.00001775, 0.00001628, -0.00000325),
            (0.00000704, 0.00000748, -0.00000209),
            (0.00000718, 0.00000804, 0.00000170),
            (0.00002656, 0.00002746, 0.00000790),
            (0.00004749, 0.00004543, 0.00000214),
            (0.00004252, 0.00004072, -0.00000476),
            (0.00003018, 0.00003092, -0.00000191),
            (0.00002699, 0.00002715, -0.00000097),
            (0.00001703, 0.00001620, -0.00000506),
            (0.00000428, 0.00000530, -0.00000174),
            (0.00001239, 0.00001382, 0.00000531),
            (0.00002729, 0.00002596, 0.00000156),
            (0.00002868, 0.00002792, -0.00000074),
            (0.00003343, 0.00003399, 0.00000293),
            (0.00004676, 0.00004625, 0.00000301),
            (0.00005396, 0.00005278, -0.00000004),
            (0.00005345, 0.00005293, -0.00000092),
            (0.00003168, 0.00002946, -0.00001162),
            (-0.00000283, -0.00000087, -0.00000638),
            (-0.00001475, -0.00001311, -0.00000105),
            (-0.00001315, -0.00001252, 0.00000133),
            (-0.00002274, -0.00002420, -0.00000638),
            (-0.00004405, -0.00004272, -0.00000361),
            (-0.00004557, -0.00004368, 0.00000310),
            (-0.00003779, -0.00003817, 0.00000116),
            (-0.00003071, -0.00003009, 0.00000375),
            (-0.00002848, -0.00002974, -0.00000208),
            (-0.00003898, -0.00003857, -0.00000210),
            (-0.00004252, -0.00004149, 0.00000093),
            (-0.00004088, -0.00004079, 0.00000044),
            (-0.00003832, -0.00003782, 0.00000189),
            (-0.00003677, -0.00003712, -0.00000035),
            (-0.00003123, -0.00003008, 0.00000437),
            (-0.00000969, -0.00000941, 0.00000722),
            (0.00001044, 0.00000910, 0.00000363),
            (0.00001423, 0.00001293, -0.00000108),
            (0.00001108, 0.00001125, -0.00000024),
            (0.00001147, 0.00001148, 0.00000007),
            (0.00001241, 0.00001234, 0.00000014),
            (0.00001171, 0.00001144, -0.00000078),
            (0.00000277, 0.00000216, -0.00000410),
            (-0.00000793, -0.00000702, -0.00000136),
            (-0.00001339, -0.00001329, -0.00000185),
            (-0.00002549, -0.00002565, -0.00000429),
            (-0.00003292, -0.00003134, 0.00000100),
            (-0.00002502, -0.00002452, 0.00000313),
            (-0.00001733, -0.00001782, 0.00000134),
            (-0.00002365, -0.00002464, -0.00000394),
            (-0.00004551, -0.00004541, -0.00000653),
            (-0.00006620, -0.00006465, -0.00000343),
            (-0.00006454, -0.00006220, 0.00000502),
            (-0.00003536, -0.00003440, 0.00001078),
            (-0.00000502, -0.00000682, 0.00000578),
            (-0.00000609, -0.00000863, -0.00000511),
            (-0.00001812, -0.00001656, 0.00000021),
            (-0.00000308, -0.00000169, 0.00000731),
            (0.00001735, 0.00001581, 0.00000293),
            (0.00002113, 0.00002010, -0.00000045),
            (0.00003106, 0.00003210, 0.00000572),
            (0.00004249, 0.00004047, -0.00000092),
            (0.00003280, 0.00003203, -0.00000415),
            (0.00001340, 0.00001317, -0.00000656),
            (0.00001931, 0.00002281, 0.00000933),
            (0.00003717, 0.00003396, -0.00000213),
            (0.00002988, 0.00003009, -0.00000091),
            (0.00002801, 0.00002789, -0.00000096),
            (0.00003134, 0.00003180, 0.00000206),
            (0.00003672, 0.00003587, -0.00000022),
            (0.00003845, 0.00003839, 0.00000068),
            (0.00003146, 0.00003004, -0.00000527),
            (0.00001752, 0.00001842, -0.00000219),
            (0.00001879, 0.00001964, 0.00000188),
            (0.00001153, 0.00000965, -0.00000660),
            (0.00000676, 0.00000945, 0.00000470),
            (0.00004009, 0.00004075, 0.00001131),
            (0.00005133, 0.00004662, -0.00000651),
            (0.00002997, 0.00003087, -0.00000356),
            (0.00002338, 0.00002396, -0.00000123),
            (0.00002932, 0.00003014, 0.00000343),
            (0.00005348, 0.00005379, 0.00000819),
            (0.00008318, 0.00008159, 0.00000613),
            (0.00012190, 0.00012201, 0.00001321),
            (0.00016188, 0.00015819, 0.00000505),
            (0.00015285, 0.00014819, -0.00001170),
            (0.00011169, 0.00011193, -0.00001148),
            (0.00007979, 0.00008077, -0.00000849),
            (0.00004777, 0.00004762, -0.00001109),
            (0.00003094, 0.00003395, 0.00000087),
            (0.00004167, 0.00004162, 0.00000237),
            (0.00007923, 0.00008128, 0.00001647),
            (0.00013930, 0.00013631, 0.00001243),
            (0.00016429, 0.00015965, -0.00000082),
            (0.00014475, 0.00014188, -0.00001103),
            (0.00013681, 0.00013984, 0.00000459),
            (0.00014166, 0.00013810, -0.00000703),
            (0.00010335, 0.00010169, -0.00001489),
            (0.00008338, 0.00008739, 0.00000239),
            (0.00009639, 0.00009515, 0.00000023),
            (0.00011672, 0.00011762, 0.00000877),
            (0.00011818, 0.00011282, -0.00001122),
            (0.00005802, 0.00005667, -0.00002071),
            (0.00003021, 0.00003666, 0.00000492),
            (0.00003799, 0.00003541, -0.00000503),
            (0.00002526, 0.00002622, -0.00000131),
            (0.00002460, 0.00002476, -0.00000022),
            (0.00002230, 0.00002189, -0.00000169),
            (0.00003096, 0.00003237, 0.00000589),
            (0.00006434, 0.00006432, 0.00001028),
            (0.00009459, 0.00009199, 0.00000429),
            (0.00007812, 0.00007373, -0.00001381),
            (0.00004005, 0.00004239, -0.00000607),
            (0.00003880, 0.00004080, 0.00000300),
            (0.00006247, 0.00006270, 0.00000747),
            (0.00006496, 0.00006098, -0.00000769),
            (0.00003372, 0.00003398, -0.00000836),
            (0.00001854, 0.00002056, -0.00000080),
            (0.00002813, 0.00002900, 0.00000426),
            (0.00003176, 0.00002972, -0.00000344),
            (0.00000236, 0.00000098, -0.00001180),
            (-0.00004138, -0.00003998, -0.00001080),
            (-0.00006912, -0.00006645, -0.00000379),
            (-0.00007652, -0.00007498, 0.00000005),
            (-0.00007195, -0.00007083, 0.00000341),
            (-0.00005328, -0.00005237, 0.00000768),
            (-0.00003317, -0.00003430, 0.00000391),
            (-0.00003325, -0.00003458, -0.00000242),
            (-0.00002752, -0.00002532, 0.00000695),
            (-0.00000673, -0.00000789, 0.00000362),
            (-0.00000447, -0.00000574, -0.00000155),
            (-0.00000361, -0.00000262, 0.00000278),
            (0.00001334, 0.00001362, 0.00000576),
            (0.00001540, 0.00001274, -0.00000504),
            (-0.00002345, -0.00002474, -0.00001446),
            (-0.00005709, -0.00005320, -0.00000228),
            (-0.00005154, -0.00004972, 0.00000443),
            (-0.00003175, -0.00003151, 0.00000637),
            (-0.00000856, -0.00000896, 0.00000665),
            (0.00002061, 0.00002047, 0.00000930),
            (0.00004850, 0.00004665, 0.00000516),
            (0.00004690, 0.00004399, -0.00000609),
            (0.00003020, 0.00003120, -0.00000241),
            (0.00001814, 0.00001764, -0.00000531),
            (0.00000911, 0.00001056, 0.00000026),
            (-0.00000232, -0.00000380, -0.00000731),
            (-0.00002894, -0.00002792, -0.00000600),
            (-0.00003799, -0.00003584, 0.00000127),
            (-0.00004103, -0.00004172, -0.00000309),
            (-0.00004502, -0.00004342, 0.00000233),
            (-0.00003847, -0.00003858, 0.00000142),
            (-0.00005649, -0.00005844, -0.00000987),
            (-0.00008506, -0.00008237, -0.00000291),
            (-0.00009879, -0.00009808, -0.00000375),
            (-0.00011503, -0.00011381, -0.00000281),
            (-0.00013054, -0.00012955, -0.00000323),
            (-0.00012077, -0.00011694, 0.00001102),
            (-0.00008059, -0.00008088, 0.00001129),
            (-0.00004855, -0.00004976, 0.00000801),
            (-0.00003441, -0.00003610, 0.00000148),
            (-0.00004360, -0.00004461, -0.00000451),
            (-0.00002879, -0.00002466, 0.00001387),
            (0.00001603, 0.00001378, 0.00000849),
            (0.00001660, 0.00001276, -0.00000716),
            (-0.00001838, -0.00001819, -0.00000972),
            (-0.00003486, -0.00003173, 0.00000119),
            (-0.00000686, -0.00000465, 0.00001274),
            (0.00003309, 0.00003085, 0.00000753),
            (0.00002900, 0.00002496, -0.00000912),
            (-0.00000820, -0.00000744, -0.00000917),
            (-0.00004619, -0.00004557, -0.00001126),
            (-0.00004410, -0.00003820, 0.00001293),
            (-0.00000913, -0.00001192, 0.00000361),
            (0.00000191, 0.00000170, 0.00000405),
            (0.00001642, 0.00001593, 0.00000375),
            (0.00002537, 0.00002435, 0.00000090),
            (0.00002556, 0.00002497, -0.00000086),
            (0.00002181, 0.00002162, -0.00000145),
            (0.00001775, 0.00001780, -0.00000116),
            (0.00001714, 0.00001741, 0.00000034),
            (0.00001950, 0.00001935, 0.00000034),
            (0.00003714, 0.00003849, 0.00000857),
            (0.00006852, 0.00006698, 0.00000648),
            (0.00009729, 0.00009644, 0.00000796),
            (0.00011045, 0.00010700, -0.00000281),
            (0.00008569, 0.00008373, -0.00001115),
            (0.00004699, 0.00004769, -0.00001054),
            (0.00002526, 0.00002746, -0.00000269),
            (0.00001188, 0.00001132, -0.00000626),
            (-0.00000570, -0.00000455, -0.00000312),
            (-0.00000858, -0.00000746, 0.00000105),
            (0.00001282, 0.00001438, 0.00000986),
            (0.00003147, 0.00002836, -0.00000100),
            (0.00002453, 0.00002431, -0.00000175),
            (0.00002185, 0.00002215, -0.00000019),
            (0.00002049, 0.00002016, -0.00000125),
            (0.00002703, 0.00002805, 0.00000434),
            (0.00003621, 0.00003466, -0.00000065),
            (0.00003142, 0.00003102, -0.00000194),
            (0.00002781, 0.00002805, -0.00000057),
            (0.00003203, 0.00003236, 0.00000195),
            (0.00003069, 0.00002925, -0.00000360),
            (0.00000395, 0.00000285, -0.00001054),
            (-0.00003458, -0.00003332, -0.00000948),
            (-0.00005482, -0.00005210, -0.00000122),
            (-0.00004927, -0.00004784, 0.00000398),
            (-0.00004143, -0.00004213, 0.00000067),
            (-0.00004721, -0.00004754, -0.00000229),
            (-0.00004909, -0.00004763, 0.00000261),
            (-0.00003218, -0.00003137, 0.00000677),
            (-0.00003109, -0.00003386, -0.00000570),
            (-0.00004922, -0.00004766, -0.00000167),
            (-0.00005274, -0.00005191, 0.00000015),
            (-0.00004279, -0.00004139, 0.00000596),
            (-0.00002846, -0.00002952, 0.00000201),
            (-0.00000844, -0.00000700, 0.00000988),
            (0.00001706, 0.00001486, 0.00000318),
            (0.00001555, 0.00001396, -0.00000312),
            (0.00000623, 0.00000678, -0.00000136),
            (0.00000895, 0.00000971, 0.00000231),
            (0.00001209, 0.00001113, -0.00000125),
            (0.00000617, 0.00000614, -0.00000167),
            (0.00000453, 0.00000509, 0.00000063),
            (0.00000215, 0.00000152, -0.00000229),
            (-0.00000228, -0.00000159, 0.00000021),
            (0.00000034, 0.00000044, 0.00000085),
            (0.00001398, 0.00001489, 0.00000629),
            (0.00003692, 0.00003595, 0.00000508),
            (0.00004457, 0.00004262, -0.00000133),
            (0.00004125, 0.00004126, -0.00000048),
            (0.00003927, 0.00003883, -0.00000160),
            (0.00003166, 0.00003127, -0.00000318),
            (0.00002150, 0.00002169, -0.00000282),
            (0.00002013, 0.00002105, 0.00000140),
            (0.00002704, 0.00002672, 0.00000126),
            (0.00002954, 0.00002892, -0.00000042),
            (0.00003186, 0.00003200, 0.00000123),
            (0.00004665, 0.00004713, 0.00000572),
            (0.00005573, 0.00005336, -0.00000224),
            (0.00004352, 0.00004301, -0.00000432)
        };

        var indicator = new MacdIndicator(
            10, 15, 3, Known.Pairs[Symbol.EURUSD], RateToUse.Close);

        var candles = IndicatorData.GetCandles();

        candles.Count.Should().Be(results.Length);

        for (var i = 0; i < candles.Count; i++)
        {
            var result = indicator.AddAndCalc(candles[i]);

            result.Value.Should().BeApproximately(results[i].Value, 8);
            result.Average.Should().BeApproximately(results[i].Average, 8);
            result.Difference.Should().BeApproximately(results[i].Difference, 8);
        }
    }
}