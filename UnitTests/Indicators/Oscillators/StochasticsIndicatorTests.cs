// ********************************************************
// Copyright (C) 2021 Louis S. Berman (louis@squideyes.com)
//
// This file is part of SquidEyes.Trading
//
// The use of this source code is licensed under the terms
// of the MIT License (https://opensource.org/licenses/MIT)
// ********************************************************

using FluentAssertions;
using SquidEyes.Trading.Context;
using SquidEyes.Trading.Indicators;
using SquidEyes.UnitTests.Testing;
using Xunit;

namespace SquidEyes.UnitTests.Indicators;

public class StochasticsIndicatorTests
{
    [Fact]
    public void StochasticsIndicatorBaseline()
    {
        var results = new (double AddK, double AddD, double UpdateK, double UpdateD)[]
        {
            (21.05263158, 21.05263158, 21.05263158, 21.05263158),
            (12.25045372, 16.65154265, 12.25045372, 16.65154265),
            (20.49573627, 17.93294052, 20.49573627, 17.93294052),
            (19.29214590, 18.27274187, 19.29214590, 18.27274187),
            (23.95667410, 19.40952831, 23.95667410, 19.40952831),
            (17.82945736, 19.14618316, 17.82945736, 19.14618316),
            (17.44186047, 18.90270849, 17.44186047, 18.90270849),
            (21.31782946, 18.94059390, 21.31782946, 18.94059390),
            (22.86821705, 20.45741723, 22.86821705, 20.45741723),
            (24.41860465, 21.01782700, 24.41860465, 21.01782700),
            (21.70542636, 21.36258135, 21.70542636, 21.36258135),
            (15.50387597, 20.15503876, 15.50387597, 20.15503876),
            (13.17829457, 19.49058693, 13.17829457, 19.49058693),
            (24.03100775, 20.43189369, 24.03100775, 20.43189369),
            (44.07686429, 23.68318438, 44.07686429, 23.68318438),
            (67.60030467, 30.07348261, 67.60030467, 30.07348261),
            (74.77084731, 37.26666013, 74.77084731, 37.26666013),
            (85.71428571, 46.41078290, 85.71428571, 46.41078290),
            (85.77497666, 56.44951157, 85.77497666, 56.44951157),
            (85.08870215, 66.72242693, 85.08870215, 66.72242693),
            (78.82352941, 74.54993003, 78.82352941, 74.54993003),
            (70.98039216, 78.39329115, 70.98039216, 78.39329115),
            (55.68627451, 76.69128684, 55.68627451, 76.69128684),
            (34.50980392, 70.93970922, 34.50980392, 70.93970922),
            (31.37254902, 63.17660397, 31.37254902, 63.17660397),
            (50.52754435, 58.14125650, 50.52754435, 58.14125650),
            (62.31262202, 54.88753077, 62.31262202, 54.88753077),
            (68.86724387, 53.46520426, 68.86724387, 53.46520426),
            (69.26406926, 53.22001528, 69.26406926, 53.22001528),
            (81.59905938, 56.92184169, 81.59905938, 56.92184169),
            (87.00764256, 64.42153292, 87.00764256, 64.42153292),
            (80.00484144, 71.36900327, 80.00484144, 71.36900327),
            (79.80634229, 75.55168869, 79.80634229, 75.55168869),
            (77.64705882, 77.74232252, 77.64705882, 77.74232252),
            (76.86274510, 78.88453698, 76.86274510, 78.88453698),
            (61.56862745, 77.78518815, 61.56862745, 77.78518815),
            (51.76470588, 73.52313765, 51.76470588, 73.52313765),
            (45.49019608, 67.59207387, 45.49019608, 67.59207387),
            (36.66666667, 61.40090604, 36.66666667, 61.40090604),
            (24.80392157, 53.54341737, 24.80392157, 53.54341737),
            (18.62745098, 45.11204482, 18.62745098, 45.11204482),
            (21.56862745, 37.21288515, 21.56862745, 37.21288515),
            (18.62745098, 31.07843137, 18.62745098, 31.07843137),
            (13.03384367, 25.54545106, 13.03384367, 25.54545106),
            (10.67015847, 20.57115997, 10.67015847, 20.57115997),
            (13.12113887, 17.20751314, 13.12113887, 17.20751314),
            (13.91676637, 15.65220526, 13.91676637, 15.65220526),
            (16.50183045, 15.34854518, 16.50183045, 15.34854518),
            (31.44113951, 16.75890405, 31.44113951, 16.75890405),
            (50.92165899, 21.37236233, 50.92165899, 21.37236233),
            (57.14285714, 27.67364997, 57.14285714, 27.67364997),
            (56.05158730, 34.15671123, 56.05158730, 34.15671123),
            (61.16071429, 41.01950772, 61.16071429, 41.01950772),
            (78.97376543, 50.31336473, 78.97376543, 50.31336473),
            (92.93981481, 61.23307678, 92.93981481, 61.23307678),
            (88.54362837, 69.39057519, 88.54362837, 69.39057519),
            (83.56350701, 74.05369634, 83.56350701, 74.05369634),
            (79.33230611, 77.22361762, 79.33230611, 77.22361762),
            (76.81561376, 80.18990711, 76.81561376, 80.18990711),
            (72.53647587, 81.81501591, 72.53647587, 81.81501591),
            (76.76767677, 81.49986039, 76.76767677, 81.49986039),
            (86.41975309, 80.56842300, 86.41975309, 80.56842300),
            (92.82001300, 81.17933509, 92.82001300, 81.17933509),
            (90.62039554, 82.18746202, 90.62039554, 82.18746202),
            (92.65663091, 84.09093699, 92.65663091, 84.09093699),
            (95.53068596, 86.76451873, 95.53068596, 86.76451873),
            (97.87139690, 90.38379316, 97.87139690, 90.38379316),
            (82.40686143, 91.18939097, 82.40686143, 91.18939097),
            (66.70329670, 88.37275435, 66.70329670, 88.37275435),
            (51.79487179, 82.51201989, 51.79487179, 82.51201989),
            (53.84615385, 77.25855679, 53.84615385, 77.25855679),
            (44.10256410, 70.32226153, 44.10256410, 70.32226153),
            (29.23076923, 60.85084486, 29.23076923, 60.85084486),
            (15.65756824, 49.10601219, 15.65756824, 49.10601219),
            (11.14143921, 38.92523759, 11.14143921, 38.92523759),
            (13.88462195, 31.37971262, 13.88462195, 31.37971262),
            (8.92302441, 25.25516300, 8.92302441, 25.25516300),
            (10.30189854, 19.03455510, 10.30189854, 19.03455510),
            (8.01120448, 13.87864658, 8.01120448, 13.87864658),
            (8.23529412, 10.87929299, 8.23529412, 10.87929299),
            (6.71391448, 9.60162817, 6.71391448, 9.60162817),
            (4.08540362, 8.59362308, 4.08540362, 8.59362308),
            (8.31433843, 7.79786830, 8.31433843, 7.79786830),
            (18.86669278, 9.21839235, 18.86669278, 9.21839235),
            (32.10720602, 12.33343628, 32.10720602, 12.33343628),
            (42.64382960, 17.28095415, 42.64382960, 17.28095415),
            (48.19938516, 22.99011001, 48.19938516, 22.99011001),
            (53.62318841, 29.69143486, 53.62318841, 29.69143486),
            (61.25839519, 37.85900508, 61.25839519, 37.85900508),
            (65.90668081, 46.08648257, 65.90668081, 46.08648257),
            (62.53193961, 52.32437497, 62.53193961, 52.32437497),
            (56.09756098, 55.75156853, 56.09756098, 55.75156853),
            (44.76190476, 56.05415070, 44.76190476, 56.05415070),
            (28.57142857, 53.25015690, 28.57142857, 53.25015690),
            (21.57349896, 48.67162984, 21.57349896, 48.67162984),
            (23.18840580, 43.23305993, 23.18840580, 43.23305993),
            (34.05797101, 38.68324424, 34.05797101, 38.68324424),
            (23.91304348, 33.16625908, 23.91304348, 33.16625908),
            (11.36707766, 26.77619003, 11.36707766, 26.77619003),
            (1.35221329, 20.57480554, 1.35221329, 20.57480554),
            (6.90776885, 17.47999701, 6.90776885, 17.47999701),
            (20.51282051, 17.32847151, 20.51282051, 17.32847151),
            (34.18803419, 18.89984700, 34.18803419, 18.89984700),
            (33.01844354, 18.75134307, 33.01844354, 18.75134307),
            (27.37359088, 19.24570699, 27.37359088, 19.24570699),
            (31.74914899, 22.15743147, 31.74914899, 22.15743147),
            (49.20226454, 28.99315307, 49.20226454, 28.99315307),
            (63.38606253, 37.06148074, 63.38606253, 37.06148074),
            (77.25836767, 45.16798748, 77.25836767, 45.16798748),
            (83.02345388, 52.14447601, 83.02345388, 52.14447601),
            (84.86111111, 59.55057137, 84.86111111, 59.55057137),
            (70.31250000, 65.68470125, 70.31250000, 65.68470125),
            (75.18696581, 71.89010365, 75.18696581, 71.89010365),
            (75.70779915, 75.67660859, 75.70779915, 75.67660859),
            (85.03418803, 78.76919795, 85.03418803, 78.76919795),
            (81.00000000, 79.30371685, 81.00000000, 79.30371685),
            (86.89430894, 79.85669615, 86.89430894, 79.85669615),
            (89.18371463, 80.47421094, 89.18371463, 80.47421094),
            (93.15936151, 83.73804830, 93.15936151, 83.73804830),
            (85.93655015, 85.27370320, 85.93655015, 85.27370320),
            (80.62862595, 85.97667846, 80.62862595, 85.97667846),
            (77.83816425, 84.94867506, 77.83816425, 84.94867506),
            (73.61111111, 83.89311951, 73.61111111, 83.89311951),
            (80.12430238, 82.92597571, 80.12430238, 82.92597571),
            (83.82800609, 82.16087449, 83.82800609, 82.16087449),
            (86.95300609, 81.27425229, 86.95300609, 81.27425229),
            (78.91865079, 80.27169524, 78.91865079, 80.27169524),
            (69.97556136, 78.74982887, 69.97556136, 78.74982887),
            (78.07278358, 78.78334592, 78.07278358, 78.78334592),
            (87.64118023, 80.78764150, 87.64118023, 80.78764150),
            (96.26980425, 83.09414177, 96.26980425, 83.09414177),
            (96.52683237, 84.90825981, 96.52683237, 84.90825981),
            (95.61843747, 86.14617858, 95.61843747, 86.14617858),
            (90.40804100, 87.78752004, 90.40804100, 87.78752004),
            (87.10865562, 90.23510493, 87.10865562, 90.23510493),
            (83.24125230, 90.97345761, 83.24125230, 90.97345761),
            (80.29465930, 89.92395462, 80.29465930, 89.92395462),
            (81.24177848, 87.77709379, 81.24177848, 87.77709379),
            (83.15218253, 85.86642953, 83.15218253, 85.86642953),
            (90.83374799, 85.18290246, 90.83374799, 85.18290246),
            (95.59565275, 85.92398985, 95.59565275, 85.92398985),
            (96.99710920, 87.33662608, 96.99710920, 87.33662608),
            (93.92433767, 88.86278113, 93.92433767, 88.86278113),
            (93.34713710, 90.72742082, 93.34713710, 90.72742082),
            (92.01746537, 92.26680466, 92.01746537, 92.26680466),
            (88.58845965, 93.04341568, 88.58845965, 93.04341568),
            (87.35047871, 92.54580578, 87.35047871, 92.54580578),
            (87.43969836, 91.38066944, 87.43969836, 91.38066944),
            (94.45814098, 91.01795969, 94.45814098, 91.01795969),
            (91.62851376, 90.68998485, 91.62851376, 90.68998485),
            (85.01104523, 89.49911458, 85.01104523, 89.49911458),
            (81.95093594, 88.06103895, 81.95093594, 88.06103895),
            (79.56056880, 86.77134025, 79.56056880, 86.77134025),
            (81.47801357, 85.93241666, 81.47801357, 85.93241666),
            (76.54688409, 84.37630034, 76.54688409, 84.37630034),
            (74.76663297, 81.56322777, 74.76663297, 81.56322777),
            (80.92580820, 80.03426983, 80.92580820, 80.03426983),
            (83.25419795, 79.78329165, 83.25419795, 79.78329165),
            (87.65461391, 80.59810278, 87.65461391, 80.59810278),
            (76.57702048, 80.17188160, 76.57702048, 80.17188160),
            (69.33479896, 78.43713665, 69.33479896, 78.43713665),
            (66.25626995, 76.96704892, 66.25626995, 76.96704892),
            (78.05590074, 77.43694431, 78.05590074, 77.43694431),
            (83.34615460, 77.78270809, 83.34615460, 77.78270809),
            (80.91603053, 77.44868417, 80.91603053, 77.44868417),
            (73.45043109, 75.41951519, 73.45043109, 75.41951519),
            (78.03814177, 75.62824681, 78.03814177, 75.62824681),
            (80.21769815, 77.18294669, 80.21769815, 77.18294669),
            (71.11044438, 77.87640018, 71.11044438, 77.87640018),
            (48.16963966, 73.60693431, 48.16963966, 73.60693431),
            (24.90599547, 65.25834015, 24.90599547, 65.25834015),
            (13.19784871, 55.58431417, 13.19784871, 55.58431417),
            (9.88571885, 46.50364100, 9.88571885, 46.50364100),
            (15.12027491, 37.51537430, 15.12027491, 37.51537430),
            (17.52577320, 28.55938502, 17.52577320, 28.55938502),
            (14.08934708, 20.41351398, 14.08934708, 20.41351398),
            (16.33313119, 15.86544134, 16.33313119, 15.86544134),
            (19.62468836, 15.11096890, 19.62468836, 15.11096890),
            (25.49019608, 16.86701852, 25.49019608, 16.86701852),
            (25.49019608, 19.09622956, 25.49019608, 19.09622956),
            (31.47698942, 21.43290306, 31.47698942, 21.43290306),
            (33.60117243, 23.72938866, 33.60117243, 23.72938866),
            (24.23584735, 25.17888870, 24.23584735, 25.17888870),
            (20.12724118, 25.72090441, 20.12724118, 25.72090441),
            (26.07962213, 26.64303781, 26.07962213, 26.64303781),
            (42.85714286, 29.12403021, 42.85714286, 29.12403021),
            (52.38095238, 32.96556682, 52.38095238, 32.96556682),
            (59.85832349, 37.02004312, 59.85832349, 37.02004312),
            (66.88463052, 41.77482285, 66.88463052, 41.77482285),
            (65.01377410, 47.60024095, 65.01377410, 47.60024095),
            (64.18732782, 53.89453904, 64.18732782, 53.89453904),
            (57.85123967, 58.43334155, 57.85123967, 58.43334155),
            (59.50413223, 60.81148289, 59.50413223, 60.81148289),
            (52.61707989, 60.84521539, 52.61707989, 60.84521539),
            (45.73002755, 58.82688740, 45.73002755, 58.82688740),
            (38.01652893, 54.70287288, 38.01652893, 54.70287288),
            (31.95592287, 49.98032271, 31.95592287, 49.98032271),
            (26.43825724, 44.58759834, 26.43825724, 44.58759834),
            (17.37409398, 38.80514896, 17.37409398, 38.80514896),
            (9.88636640, 31.71689669, 9.88636640, 31.71689669),
            (7.08745098, 25.21266399, 7.08745098, 25.21266399),
            (5.30185793, 19.43721119, 5.30185793, 19.43721119),
            (8.25588935, 15.18569125, 8.25588935, 15.18569125),
            (6.68313015, 11.57529229, 6.68313015, 11.57529229),
            (9.85829774, 9.20672665, 9.85829774, 9.20672665),
            (12.80602637, 8.55414556, 12.80602637, 8.55414556),
            (19.08349027, 9.86802040, 19.08349027, 9.86802040),
            (19.47935483, 11.63829238, 19.47935483, 11.63829238),
            (13.98337113, 12.87850855, 13.98337113, 12.87850855),
            (18.83086568, 14.38921945, 18.83086568, 14.38921945),
            (26.88742164, 17.27554681, 26.88742164, 17.27554681),
            (32.10784314, 20.45405329, 32.10784314, 20.45405329),
            (21.28972279, 21.66600992, 21.28972279, 21.66600992),
            (16.73089926, 21.32992549, 16.73089926, 21.32992549),
            (34.35344828, 23.45479599, 34.35344828, 23.45479599),
            (60.00000000, 30.02860011, 60.00000000, 30.02860011),
            (63.75000000, 36.44561930, 63.75000000, 36.44561930),
            (47.08333333, 39.33074954, 47.08333333, 39.33074954),
            (20.00000000, 37.60105766, 20.00000000, 37.60105766),
            (25.56159420, 38.21132501, 25.56159420, 38.21132501),
            (32.60869565, 40.47958164, 32.60869565, 40.47958164),
            (50.00000000, 42.71480331, 50.00000000, 42.71480331),
            (51.81159420, 41.54503106, 51.81159420, 41.54503106),
            (58.33333333, 40.77122153, 58.33333333, 40.77122153),
            (61.82114986, 42.87662389, 61.82114986, 42.87662389),
            (62.41041567, 48.93525470, 62.41041567, 48.93525470),
            (63.00366300, 54.28412168, 63.00366300, 54.28412168),
            (65.20146520, 58.94023161, 65.20146520, 58.94023161),
            (68.49816850, 61.58282711, 68.49816850, 61.58282711),
            (80.24594453, 65.64487716, 80.24594453, 65.64487716),
            (86.82781411, 69.71551727, 86.82781411, 69.71551727),
            (93.99856830, 74.31229133, 93.99856830, 74.31229133),
            (91.24819662, 78.43197432, 91.24819662, 78.43197432),
            (86.91240139, 81.84750838, 86.91240139, 81.84750838),
            (78.56323904, 83.75633321, 78.56323904, 83.75633321),
            (73.17917050, 84.42504778, 73.17917050, 84.42504778),
            (68.47764201, 82.74386171, 68.47764201, 82.74386171),
            (65.81920904, 79.74263241, 65.81920904, 79.74263241),
            (62.99435028, 75.31345841, 62.99435028, 75.31345841),
            (72.88135593, 72.68962403, 72.88135593, 72.68962403),
            (78.43768969, 71.47895093, 78.43768969, 71.47895093),
            (82.57459028, 72.05200110, 82.57459028, 72.05200110),
            (77.44490358, 72.66139154, 77.44490358, 72.66139154),
            (72.01742303, 73.16707455, 72.01742303, 73.16707455),
            (77.42557150, 74.82512633, 77.42557150, 74.82512633),
            (79.82456140, 77.22944220, 79.82456140, 77.22944220),
            (87.13450292, 79.26560606, 87.13450292, 79.26560606),
            (86.11111111, 80.36180912, 86.11111111, 80.36180912),
            (91.66666667, 81.66067718, 91.66666667, 81.66067718),
            (89.45966514, 83.37707168, 89.45966514, 83.37707168),
            (72.60273973, 83.46068835, 72.60273973, 83.46068835),
            (44.74885845, 78.79258649, 44.74885845, 78.79258649),
            (22.71343573, 70.63385425, 22.71343573, 70.63385425),
            (15.58046216, 60.41184843, 15.58046216, 60.41184843),
            (14.66722015, 50.20557829, 14.66722015, 50.20557829),
            (11.97574847, 38.82116140, 11.97574847, 38.82116140),
            (8.36367840, 27.23602044, 8.36367840, 27.23602044),
            (11.81434599, 18.55196419, 11.81434599, 18.55196419),
            (11.67968399, 13.82779641, 11.67968399, 13.82779641),
            (10.72609750, 12.11531952, 10.72609750, 12.11531952),
            (3.04255319, 10.32418967, 3.04255319, 10.32418967),
            (6.66666667, 9.18125346, 6.66666667, 9.18125346),
            (6.66666667, 8.42281320, 6.66666667, 8.42281320),
            (19.12403101, 9.96000643, 19.12403101, 9.96000643),
            (31.18414030, 12.72711990, 31.18414030, 12.72711990),
            (42.10931037, 17.07420938, 42.10931037, 17.07420938),
            (43.60432698, 21.77109931, 43.60432698, 21.77109931),
            (49.19669996, 28.36454885, 49.19669996, 28.36454885),
            (54.38747192, 35.18180674, 54.38747192, 35.18180674),
            (56.76842430, 42.33920069, 56.76842430, 42.33920069),
            (55.07246377, 47.47469108, 55.07246377, 47.47469108),
            (52.46039771, 50.51415643, 52.46039771, 50.51415643),
            (54.84135009, 52.33301924, 54.84135009, 52.33301924),
            (55.18641565, 53.98760334, 55.18641565, 53.98760334),
            (67.56132756, 56.61112157, 67.56132756, 56.61112157),
            (80.69761656, 60.36971366, 80.69761656, 60.36971366),
            (88.99351353, 64.97329784, 88.99351353, 64.97329784),
            (93.78139232, 70.50314478, 93.78139232, 70.50314478),
            (93.04402516, 76.30080584, 93.04402516, 76.30080584),
            (93.67295597, 81.84817811, 93.67295597, 81.84817811),
            (89.57771788, 86.76122128, 89.57771788, 86.76122128),
            (86.62580066, 89.48471744, 86.62580066, 89.48471744),
            (88.24884793, 90.56346478, 88.24884793, 90.56346478),
            (91.39784946, 90.90694134, 91.39784946, 90.90694134),
            (95.75346735, 91.18866634, 95.75346735, 91.18866634),
            (95.49850670, 91.53930657, 95.49850670, 91.53930657),
            (91.95677076, 91.29413725, 91.95677076, 91.29413725),
            (85.38103901, 90.69461170, 85.38103901, 90.69461170)
        };

        var indicator = new StochasticsIndicator(
            14, 7, 3, Known.Pairs[Symbol.EURUSD]);

        var candles = IndicatorData.GetCandles();

        candles.Count.Should().Be(results.Length);

        for (var i = 0; i < candles.Count; i++)
        {
            var add = indicator.AddAndCalc(candles[i]);

            add.K.Should().BeApproximately(results[i].AddK, 8);
            add.D.Should().BeApproximately(results[i].AddD, 8);

            var update = indicator.UpdateAndCalc(candles[i]);

            update.K.Should().BeApproximately(results[i].UpdateK, 8);
            update.D.Should().BeApproximately(results[i].UpdateD, 8);
        }
    }
}